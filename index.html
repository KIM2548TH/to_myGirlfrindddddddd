<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday My Love</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Mali', cursive;
            background-color: #ffe4e6;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Heart Canvas Styling */
        #heart-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: pointer;
        }

        /* Screen Transitions */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 20;
        }

        /* Cake Screen Specifics */
        #screen-cake {
            background-color: #fff1f2;
            transition: background-color 3s ease, opacity 1.5s ease-in-out;
        }

        #screen-cake.lights-out {
            background-color: #1a050a;
        }

        #screen-cake.lights-out .title-text {
            color: #ff9ec5;
            text-shadow: 0 0 15px rgba(255, 100, 150, 0.8);
            transition: all 3s ease;
        }
        
        #screen-cake.lights-out .subtitle-text {
            color: #ffc4dd;
            opacity: 0.8;
            transition: all 3s ease;
        }

        /* Cake CSS Animation */
        .cake-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin-top: 20px; 
            z-index: 10;
        }

        .plate {
            width: 270px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            position: absolute;
            bottom: 0;
            left: -10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: scaleX(0);
            transition: transform 0.5s ease;
        }

        .lights-out .plate, 
        .lights-out .layer, 
        .lights-out .icing, 
        .lights-out .drip {
            filter: brightness(0.8);
            transition: filter 3s ease;
        }

        .layer {
            position: absolute;
            background: #fbcfe8;
            width: 200px;
            height: 60px;
            left: 25px;
            border-radius: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .layer.bottom { bottom: 10px; background: #f9a8d4; }
        .layer.middle { bottom: 70px; background: #f472b6; width: 180px; left: 35px; }
        .layer.top { bottom: 130px; background: #ec4899; width: 160px; left: 45px; }

        .icing {
            position: absolute;
            background: #fff;
            width: 170px;
            height: 20px;
            top: 0;
            left: -5px;
            border-radius: 10px 10px 0 0;
        }
        
        .drip {
            position: absolute;
            background: #fff;
            width: 15px;
            height: 25px;
            border-radius: 0 0 10px 10px;
            top: 15px;
        }

        .candle {
            position: absolute;
            width: 10px;
            height: 40px;
            background: repeating-linear-gradient(45deg, #fff, #fff 5px, #3b82f6 5px, #3b82f6 10px);
            bottom: 190px;
            left: 120px;
            border-radius: 2px;
            transform: scaleY(0);
            transform-origin: bottom;
            transition: transform 0.5s ease;
        }

        .flame {
            position: absolute;
            width: 14px;
            height: 20px;
            background: #fbbf24;
            border-radius: 50% 50% 20% 20%;
            bottom: 45px;
            left: -2px;
            animation: flicker 0.5s infinite alternate;
            box-shadow: 0 0 10px #fbbf24, 0 0 20px #f59e0b;
            opacity: 0;
            transition: opacity 0.3s, box-shadow 3s ease;
        }

        .lights-out .flame {
            box-shadow: 0 0 40px 10px rgba(251, 191, 36, 0.8), 
                        0 0 80px 20px rgba(245, 158, 11, 0.4),
                        0 0 120px 40px rgba(255, 100, 100, 0.2);
            background: #fff;
        }

        @keyframes flicker {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* Build Animation Classes */
        .build-step-1 .plate { transform: scaleX(1); }
        .build-step-2 .layer.bottom { opacity: 1; transform: translateY(0); }
        .build-step-3 .layer.middle { opacity: 1; transform: translateY(0); }
        .build-step-4 .layer.top { opacity: 1; transform: translateY(0); }
        .build-step-5 .candle { transform: scaleY(1); }
        .build-step-6 .flame { opacity: 1; }
        .blown .flame { opacity: 0; animation: none; }
        
        /* Message Styling - CENTERED */
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            width: 85%;
            max-width: 400px;
            text-align: center;
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            pointer-events: none; 
        }
        
        .message-box.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        /* Flower Petals Styling */
        .petal {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            z-index: 55; 
        }

        /* Photo Heart Effect - Floating randomly */
        .photo-floating {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 8px;
            object-fit: cover;
            pointer-events: auto;
            z-index: 30;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .photo-floating.enlarged {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(3.5) !important;
            z-index: 200;
            border-width: 4px;
        }

        /* Photo Carousel */
        .carousel-container {
            position: relative;
            width: 90%;
            max-width: 400px;
            height: 500px;
            margin: 20px auto;
        }

        .carousel-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .carousel-slide.active {
            opacity: 1;
            pointer-events: auto;
        }

        .flip-card {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: white;
            padding: 15px;
        }

        .card-face img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #f5f5f5;
        }

        .card-back {
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .card-back img {
            width: 200px;
            height: 200px;
            object-fit: contain;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .carousel-nav:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev { left: -25px; }
        .carousel-nav.next { right: -25px; }

        .carousel-indicators {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(244, 114, 182, 0.4);
            cursor: pointer;
            transition: all 0.3s;
        }

        .indicator.active {
            background: #f472b6;
            width: 30px;
            border-radius: 5px;
        }

        /* Flip Card Styling - Responsive Size */
        .flip-container {
            perspective: 1000px;
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            width: 240px; 
            height: 320px;
            position: relative;
            animation: float 4s ease-in-out infinite;
        }
        
        /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        @media (min-width: 640px) {
            .flip-container {
                width: 280px;
                height: 380px;
            }
        }

        .flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform-origin: center;
        }

        .flip-container.flipped .flip-inner {
            transform: rotateY(180deg);
        }

        .photo-front, .photo-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            background: white;
            padding: 12px;
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
        }

        .photo-back {
            transform: rotateY(180deg);
            justify-content: center;
            align-items: center;
            background: #fff0f5;
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #eee;
            border: 1px solid #eee;
        }

        .tape {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 25px;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 5;
        }
        
        /* Floating Text Animation */
        .floating-text {
            animation: float-delayed 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: rotate(-3deg) translateY(0); }
            50% { transform: rotate(-3deg) translateY(-8px); }
        }

        @keyframes float-delayed {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* YouTube Player Hidden but Accessible */
        #youtube-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0.01;
            pointer-events: none;
            z-index: -1;
        }

        .hidden-elm { display: none; }
    </style>
</head>
<body>

    <!-- YouTube Player Container -->
    <div id="youtube-player"></div>

    <!-- Scene 1: Heart Forming -->
    <div id="screen-heart" class="screen active z-50 bg-black">
        <canvas id="heart-canvas"></canvas>
    </div>

    <!-- Scene 2: The Cake -->
    <div id="screen-cake" class="screen">
        <div class="title-text text-4xl text-pink-600 font-bold mb-1 drop-shadow-sm transition-colors duration-1000" style="font-family: 'Mali', cursive;">Happy Birthday</div>
        <div class="subtitle-text text-xl text-pink-400 mb-4 transition-colors duration-1000">To My Dearest</div>
        
        <div class="cake-container" id="cake">
            <div class="plate"></div>
            <div class="layer bottom"></div>
            <div class="layer middle"></div>
            <div class="layer top">
                <div class="icing">
                    <div class="drip" style="left: 10px;"></div>
                    <div class="drip" style="left: 40px; height: 20px;"></div>
                    <div class="drip" style="left: 70px;"></div>
                    <div class="drip" style="left: 100px; height: 18px;"></div>
                    <div class="drip" style="left: 130px;"></div>
                </div>
            </div>
            <div class="candle">
                <div class="flame"></div>
            </div>
        </div>

        <div id="blow-hint" class="absolute bottom-20 text-gray-400 opacity-0 transition-opacity duration-1000 animate-pulse">
            Tap the cake to make a wish...
        </div>

        <!-- CENTERED MESSAGE BOX -->
        <div id="wish-message" class="message-box">
            <p class="text-pink-500 font-bold text-xl mb-4">Dear My Love....</p>
            <p class="text-gray-700 leading-relaxed text-base italic mb-6">
                "I wrote this intentionally for you,<br>
                for you alone to know its meaning.<br>
                Even if not translated,<br>
                may all my feelings reach you.<br>
                To the moon and back..... üíê"
            </p>
            <button id="next-btn" onclick="nextScene()" class="bg-gradient-to-r from-pink-400 to-pink-500 text-white px-6 py-2 rounded-full text-sm shadow-lg hover:from-pink-500 hover:to-pink-600 transition transform hover:scale-105">
                Next Chapter üëâ
            </button>
        </div>
    </div>

    <!-- Scene 3: Final Photo Carousel -->
    <div id="screen-final" class="screen bg-gradient-to-b from-pink-100 to-pink-200 overflow-y-auto">
        <div class="flex flex-col items-center justify-start min-h-screen py-10 px-4">
            
            <h2 class="text-2xl font-bold text-pink-600 mb-6" style="font-family: 'Mali', cursive;">Our Memories üíï</h2>
            
            <!-- Carousel Container -->
            <div class="carousel-container">
                <div id="carousel-slides">
                    <!-- Slides will be added dynamically -->
                </div>
                <button class="carousel-nav prev" onclick="prevSlide()">‚Äπ</button>
                <button class="carousel-nav next" onclick="nextSlide()">‚Ä∫</button>
                <div class="carousel-indicators" id="carousel-indicators"></div>
            </div>

            <!-- Floating Text -->
            <div class="mt-16 text-center px-4 floating-text">
                <p class="text-pink-600 text-base italic opacity-80 mb-1 font-light">"Birds of a Feather"</p>
                <h1 class="text-lg md:text-xl text-pink-700 font-light leading-relaxed tracking-wide" style="font-family: 'Mali', cursive;">
                    "From the first day I heard it,<br>and every time I reminisce."
                </h1>
            </div>

            <!-- Music Control Button -->
            <div class="mt-6 flex gap-3 mb-10">
                <button id="pause-music-btn" onclick="toggleMusic()" class="bg-pink-500 text-white px-6 py-2 rounded-full text-sm shadow-lg hover:bg-pink-600 transition transform hover:scale-105">
                    ‚è∏Ô∏è Pause Music
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Player -->
    <audio id="background-music" loop>
        <source src="Billie Eilish - BIRDS OF A FEATHER (Official Lyric Video).mp3" type="audio/mpeg">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // --- Audio Player ---
        const audioPlayer = document.getElementById('background-music');

        // --- Stage 1: Light Heart Animation ---
        const canvas = document.getElementById('heart-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let isTransitioning = false; 
        
        let coreOpacity = 0;
        let haloOpacity = 0;
        let textOpacity = 0;
        let whiteFadeProgress = 0;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function getHeartPoint(t) {
            const scale = Math.min(width, height) / 35; 
            const x = 16 * Math.pow(Math.sin(t), 3);
            const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
            return {
                x: width/2 + x * scale,
                y: height/2 + y * scale - 30 
            };
        }

        class Particle {
            constructor(target, delay, startX, startY) {
                if (startX !== undefined && startY !== undefined) {
                    this.x = startX;
                    this.y = startY;
                    this.speed = 0.03 + Math.random() * 0.02;
                    this.delay = 0; 
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.max(width, height) * (0.6 + Math.random());
                    this.x = width/2 + Math.cos(angle) * dist;
                    this.y = height/2 + Math.sin(angle) * dist;
                    this.speed = 0.015 + Math.random() * 0.02; 
                    this.delay = delay;
                }

                if (target) {
                    const scatterX = (Math.random() - 0.5) * 25; 
                    const scatterY = (Math.random() - 0.5) * 25; 
                    this.target = {
                        x: target.x + scatterX,
                        y: target.y + scatterY
                    };
                } else {
                    this.target = { x: width/2, y: height/2 }; 
                }

                this.radius = 1.5 + Math.random() * 2;
                this.color = `hsla(${Math.random() < 0.2 ? 330 : 0}, ${Math.random() < 0.2 ? 100 : 0}%, 100%, 0.8)`;
                
                this.timer = 0;
                this.arrived = false;
                this.alpha = 1;
                
                this.implosionDelay = Math.random() * 60; 
                this.implosionTimer = 0;
            }

            update() {
                if (isTransitioning) {
                    this.implosionTimer++;
                    if (this.implosionTimer < this.implosionDelay) return;

                    const centerX = width / 2;
                    const centerY = height / 2 + 10;
                    const dx = centerX - this.x;
                    const dy = centerY - this.y;
                    
                    this.x += dx * 0.12; 
                    this.y += dy * 0.12;
                    
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 20) {
                        this.alpha -= 0.15;
                    }
                    return;
                }

                if (this.timer < this.delay) {
                    this.timer++;
                    return;
                }
                
                const dx = this.target.x - this.x;
                const dy = this.target.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 2) {
                    this.arrived = true;
                    this.x += (Math.random() - 0.5); 
                    this.y += (Math.random() - 0.5);
                } else {
                    this.x += dx * this.speed;
                    this.y += dy * this.speed;
                }
            }

            draw() {
                if (this.timer < this.delay || this.alpha <= 0) return;
                
                ctx.beginPath();
                ctx.globalAlpha = this.alpha; 
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.shadowBlur = 5;
                ctx.shadowColor = "white";
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.shadowBlur = 0; 
                ctx.globalAlpha = 1; 
            }
        }

        function initHeart() {
            particles = [];
            const totalPoints = 500; 
            for (let i = 0; i < totalPoints; i++) {
                const t = (Math.PI * 2 * i) / totalPoints;
                const target = getHeartPoint(t);
                const p = new Particle(target, i * 0.15);
                particles.push(p); 
            }
        }

        let animationFrame;

        function animateHeart() {
            ctx.fillStyle = 'black'; 
            ctx.fillRect(0, 0, width, height);

            let arrivedCount = 0;
            
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();
                if(p.arrived && !isTransitioning) arrivedCount++;
                if(p.alpha <= 0) particles.splice(i, 1);
            }

            if (arrivedCount > 400 && !isTransitioning) {
                if (coreOpacity < 1) coreOpacity += 0.01;
                else if (haloOpacity < 1) haloOpacity += 0.01;
                else if (textOpacity < 1) textOpacity += 0.02;
            }

            if (coreOpacity > 0 || isTransitioning) {
                drawButton();
            }

            if (isTransitioning) {
                if (whiteFadeProgress < 1) {
                    whiteFadeProgress += 0.01;
                }
                ctx.fillStyle = `rgba(255, 255, 255, ${whiteFadeProgress})`;
                ctx.fillRect(0, 0, width, height);
            }

            if (whiteFadeProgress >= 1) {
                cancelAnimationFrame(animationFrame);
                completeTransition();
                return;
            }

            animationFrame = requestAnimationFrame(animateHeart);
        }

        function drawButton() {
            const centerX = width / 2;
            const centerY = height / 2 + 10; 
            const time = Date.now() / 1500;
            
            if (haloOpacity > 0 || isTransitioning) {
                const haloScale = 1 + Math.sin(time) * 0.05;
                ctx.globalAlpha = isTransitioning ? 1 : haloOpacity;
                ctx.beginPath();
                ctx.fillStyle = `rgba(255, 255, 255, ${0.1 + Math.sin(time) * 0.05})`;
                ctx.arc(centerX, centerY, 13 * 3.5 * haloScale, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.globalAlpha = isTransitioning ? 1 : coreOpacity;
            ctx.beginPath();
            ctx.fillStyle = "#ffffff";
            if (isTransitioning) {
                ctx.shadowBlur = 30;
                ctx.shadowColor = "white";
            } else {
                ctx.shadowBlur = 20 * coreOpacity;
                ctx.shadowColor = "rgba(255, 255, 255, 0.4)";
            }
            ctx.arc(centerX, centerY, 13, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            if (textOpacity > 0 && !isTransitioning) {
                ctx.globalAlpha = textOpacity;
                ctx.fillStyle = "white";
                ctx.font = "bold 16px Mali";
                ctx.textAlign = "center";
                ctx.fillText("Click", centerX, centerY + 40);
            }
            
            ctx.globalAlpha = 1;
        }

        canvas.addEventListener('click', (e) => {
            if (isTransitioning) return;

            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            const centerX = width / 2;
            const centerY = height / 2 + 10;
            const dist = Math.sqrt((clickX - centerX) ** 2 + (clickY - centerY) ** 2);

            if (textOpacity >= 0.8 && dist < 40) {
                transitionToCake();
            } else {
                createManualParticle(clickX, clickY);
            }
        });

        function createManualParticle(x, y) {
            let target;
            if (textOpacity >= 0.5) {
                target = { x: width / 2, y: height / 2 + 10 };
            } else {
                const t = Math.random() * Math.PI * 2;
                target = getHeartPoint(t);
            }
            
            // Create multiple particles instead of just one
            const particleCount = 8 + Math.floor(Math.random() * 7); // 8-14 particles
            for (let i = 0; i < particleCount; i++) {
                // Add slight random offset to starting position
                const offsetX = x + (Math.random() - 0.5) * 20;
                const offsetY = y + (Math.random() - 0.5) * 20;
                
                // Random target if before button appears, otherwise center
                let particleTarget;
                if (textOpacity >= 0.5) {
                    particleTarget = { x: width / 2, y: height / 2 + 10 };
                } else {
                    const t = Math.random() * Math.PI * 2;
                    particleTarget = getHeartPoint(t);
                }
                
                const p = new Particle(particleTarget, 0, offsetX, offsetY);
                particles.push(p);
            }
        }

        initHeart();
        animateHeart();

        function transitionToCake() {
            isTransitioning = true; 
        }

        function completeTransition() {
            const heartScreen = document.getElementById('screen-heart');
            heartScreen.style.opacity = '0';
            
            setTimeout(() => {
                heartScreen.classList.remove('active');
                document.getElementById('screen-cake').classList.add('active');
                startCakeBuilding();
            }, 500);
        }

        // --- Stage 3: Cake Building ---
        function startCakeBuilding() {
            const cake = document.getElementById('cake');
            
            const steps = [
                { delay: 500, class: 'build-step-1' }, 
                { delay: 1200, class: 'build-step-2' }, 
                { delay: 1900, class: 'build-step-3' }, 
                { delay: 2600, class: 'build-step-4' }, 
                { delay: 3300, class: 'build-step-5' }, 
                { delay: 4000, class: 'build-step-6' }, 
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    cake.classList.add(step.class);
                }, step.delay);
            });

            // Lights out effect after cake is done (approx 5s mark)
            setTimeout(() => {
                document.getElementById('screen-cake').classList.add('lights-out');
            }, 4500);

            setTimeout(() => {
                document.getElementById('blow-hint').classList.remove('opacity-0');
                
                document.body.addEventListener('click', blowCandle, { once: true });
                document.body.addEventListener('touchstart', blowCandle, { once: true });
            }, 5500);
        }

        // --- Stage 4: Blow Candle & Message ---
        function blowCandle(e) {
            if(document.getElementById('cake').classList.contains('blown')) return;

            const cake = document.getElementById('cake');
            cake.classList.add('blown'); 
            
            // Turn lights back on
            document.getElementById('screen-cake').classList.remove('lights-out');

            document.getElementById('blow-hint').style.opacity = '0';
            document.getElementById('blow-hint').style.display = 'none'; 
            
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#f9a8d4', '#f472b6', '#ec4899', '#fff']
            });

            // Show centered message after light returns
            setTimeout(() => {
                document.getElementById('wish-message').classList.add('show');
            }, 1000);
        }

        // --- New Interaction: Flower Petals on Click ---
        document.getElementById('screen-cake').addEventListener('click', function(e) {
            const messageBox = document.getElementById('wish-message');
            if (!messageBox.classList.contains('show')) return;
            if (e.target.closest('button')) return;

            createPetals(e.clientX, e.clientY);
        });

        function createPetals(x, y) {
            const container = document.getElementById('screen-cake');
            const messageBox = document.getElementById('wish-message');
            const rect = messageBox.getBoundingClientRect();
            
            for(let i=0; i<4; i++) {
                const petal = document.createElement('div');
                petal.classList.add('petal');
                petal.innerText = ['üå∏', 'üíÆ', 'üçÉ', 'üèµÔ∏è', 'üåπ'][Math.floor(Math.random() * 5)];
                petal.style.left = x + 'px';
                petal.style.top = y + 'px';
                
                const startX = x + (Math.random() - 0.5) * 30;
                const startY = y + (Math.random() - 0.5) * 30;
                
                const angle = Math.random() * Math.PI * 2;
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                
                const radiusX = rect.width / 1.8 + (Math.random() * 20);
                const radiusY = rect.height / 1.8 + (Math.random() * 20);
                
                const targetX = cx + Math.cos(angle) * radiusX;
                const targetY = cy + Math.sin(angle) * radiusY;

                container.appendChild(petal);

                petal.animate([
                    { transform: `translate(0, 0) scale(0)`, opacity: 0 },
                    { transform: `translate(${startX - x}px, ${startY - y}px) scale(1.2)`, opacity: 1, offset: 0.2 },
                    { transform: `translate(${targetX - x}px, ${targetY - y}px) rotate(${Math.random()*360}deg) scale(${0.8 + Math.random()*0.4})`, opacity: 1 }
                ], {
                    duration: 1500 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                    fill: 'forwards'
                });
            }
        }

        // --- Stage 5: Final Scene with Gallery ---
        function nextScene() {
            // Play MP3 file
            audioPlayer.volume = 1.0;
            audioPlayer.play().catch(err => {
                console.log("Audio play failed:", err);
            });

            document.getElementById('screen-cake').classList.remove('active');
            document.getElementById('screen-final').classList.add('active');
            
            // Initialize gallery
            initGallery();
        }

        // --- Photo Carousel Gallery ---
        const carouselPhotos = [
            'Screenshot From 2026-01-14 13-54-11.png',
            '087721cc-0318-4cd1-9f0b-6e378a7cc9ce.jpeg',
            '25283dcf-082b-4a37-8d9f-29f9cdc0a1dc.jpeg',
            '371df54d-2b38-4c9c-9ecc-1777d586f722.jpeg',
            '46ac7b38-70c1-4be8-872a-b07873cc9af9.jpeg',
            '626ec92b-53ed-4798-a70e-be8dbeb43b02.jpeg',
            '8c699ec6-e6d8-4188-8676-6e9b457a2878.jpeg',
            'b30aeacc-908e-4ee6-9b81-d253ca2c2e45.jpeg',
            'cccf46ba-6464-4d2c-892f-56008316b0f3.jpeg',
            'ce581ef7-8a72-43c4-a7bf-b717c1a47151.jpeg',
            'd0ac3961-e317-407f-aa0a-2eaff7aa2c7c.jpeg',
            'f54ffc8b-afa3-4738-ab38-7edefd568116.jpeg',
            'f867c565-33d4-4aad-820d-c45f57e30c37.jpeg',
            'f8d3011e-94cc-4e0f-a053-406c2e47a76d.jpeg',
            'Screenshot_14-1-2026_142543_www.instagram.com.jpeg'
        ];

        let currentSlideIndex = 0;

        function initGallery() {
            const slidesContainer = document.getElementById('carousel-slides');
            const indicatorsContainer = document.getElementById('carousel-indicators');
            
            slidesContainer.innerHTML = '';
            indicatorsContainer.innerHTML = '';
            
            carouselPhotos.forEach((photo, index) => {
                // Create slide
                const slide = document.createElement('div');
                slide.className = 'carousel-slide' + (index === 0 ? ' active' : '');
                
                const flipCard = document.createElement('div');
                flipCard.className = 'flip-card';
                flipCard.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="card-face">
                            <img src="${photo}" alt="Memory ${index + 1}">
                        </div>
                        <div class="card-face card-back">
                            <p class="text-pink-500 font-bold text-lg mb-4">Scan for Another Song üéµ</p>
                            <img src="bing_generated_qrcode (1).png" alt="QR Code">
                            <a href="https://youtu.be/5AQZ5U17J5M" target="_blank" class="mt-4 bg-pink-500 text-white px-5 py-2 rounded-full text-sm hover:bg-pink-600 transition inline-block shadow-lg">
                                üéµ Listen Now
                            </a>
                        </div>
                    </div>
                `;
                
                // Click card to flip (not navigation buttons)
                flipCard.addEventListener('click', (e) => {
                    if (!e.target.closest('.carousel-nav')) {
                        flipCard.classList.toggle('flipped');
                    }
                });
                
                slide.appendChild(flipCard);
                slidesContainer.appendChild(slide);
                
                // Create indicator
                const indicator = document.createElement('div');
                indicator.className = 'indicator' + (index === 0 ? ' active' : '');
                indicator.onclick = () => goToSlide(index);
                indicatorsContainer.appendChild(indicator);
            });
        }

        function goToSlide(index) {
            const slides = document.querySelectorAll('.carousel-slide');
            const indicators = document.querySelectorAll('.indicator');
            
            slides[currentSlideIndex].classList.remove('active');
            indicators[currentSlideIndex].classList.remove('active');
            
            currentSlideIndex = index;
            
            slides[currentSlideIndex].classList.add('active');
            indicators[currentSlideIndex].classList.add('active');
        }

        function nextSlide() {
            let newIndex = currentSlideIndex + 1;
            if (newIndex >= carouselPhotos.length) newIndex = 0;
            goToSlide(newIndex);
        }

        function prevSlide() {
            let newIndex = currentSlideIndex - 1;
            if (newIndex < 0) newIndex = carouselPhotos.length - 1;
            goToSlide(newIndex);
        }

        // --- Music Control ---
        function toggleMusic() {
            const btn = document.getElementById('pause-music-btn');
            if (audioPlayer.paused) {
                audioPlayer.play();
                btn.innerHTML = '‚è∏Ô∏è Pause Music';
            } else {
                audioPlayer.pause();
                btn.innerHTML = '‚ñ∂Ô∏è Play Music';
            }
        }

        // --- Final Screen Flower Effect ---
        document.getElementById('screen-final').addEventListener('click', function(e) {
            // Don't create flowers if clicking on buttons or flip card
            if (e.target.closest('button') || e.target.closest('.flip-container')) return;
            
            createFinalPetals(e.clientX, e.clientY);
        });

        function createFinalPetals(x, y) {
            const container = document.getElementById('screen-final');
            const flowerCount = 5 + Math.floor(Math.random() * 4); // 5-8 flowers
            
            for(let i=0; i<flowerCount; i++) {
                const petal = document.createElement('div');
                petal.classList.add('petal');
                petal.innerText = ['üå∏', 'üíÆ', 'üå∫', 'üèµÔ∏è', 'üåπ', 'üåº', 'üå∑'][Math.floor(Math.random() * 7)];
                petal.style.left = x + 'px';
                petal.style.top = y + 'px';
                petal.style.fontSize = (15 + Math.random() * 10) + 'px';
                
                // Random scatter around click point
                const scatterX = (Math.random() - 0.5) * 60;
                const scatterY = (Math.random() - 0.5) * 60;

                container.appendChild(petal);

                petal.animate([
                    { transform: `translate(0, 0) scale(0) rotate(0deg)`, opacity: 0 },
                    { transform: `translate(${scatterX}px, ${scatterY}px) scale(1.2) rotate(${Math.random()*360}deg)`, opacity: 1, offset: 0.3 },
                    { transform: `translate(${scatterX}px, ${scatterY + 20}px) scale(1) rotate(${Math.random()*720}deg)`, opacity: 1, offset: 0.7 },
                    { transform: `translate(${scatterX}px, ${scatterY + 30}px) scale(0.8) rotate(${Math.random()*1080}deg)`, opacity: 0 }
                ], {
                    duration: 1500 + Math.random() * 800,
                    easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                    fill: 'forwards'
                });

                // Remove element after animation
                setTimeout(() => {
                    if (petal.parentNode) {
                        petal.parentNode.removeChild(petal);
                    }
                }, 2500);
            }
        }

    </script>
</body>
</html>